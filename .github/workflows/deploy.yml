name: Deploy React Frontend to Droplet

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§¹ Checkout code
        uses: actions/checkout@v3

      - name: ðŸ§± Install dependencies and build
        run: |
          yarn install
          yarn build

      - name: ðŸ§ª Verify build output
        run: |
          echo "ðŸ—‚ï¸ Workspace root:"
          ls -lah
          echo "ðŸ“ dist folder:"
          ls -lah dist || echo "dist folder missing"
          echo "ðŸ“„ Files to upload:"
          find dist -type f 2>/dev/null || echo "No dist files found"
          ls -lah package.json

      - name: ðŸ“¦ Upload to Droplet
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.DROPLET_IP }}
          username: root
          key: ${{ secrets.DROPLET_SSH_KEY }}
          port: 22
          source: "dist/,package.json"
          target: "/var/www/html/"
          overwrite: true
          debug: true

      - name: ðŸš€ Deploy and setup
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DROPLET_IP }}
          username: root
          key: ${{ secrets.DROPLET_SSH_KEY }}
          port: 22
          script: |
            cd /var/www/html
            echo "ðŸ“ Files uploaded:"
            ls -lah

            # Move dist contents to web root
            if [ -d "dist" ]; then
              echo "ðŸ“¦ Moving React build files to web root..."
              cp -r dist/* . 2>/dev/null || echo "No files to move"
              rm -rf dist
            fi

            echo "ðŸ“„ Final web root contents:"
            ls -lah

            # Set proper permissions
            chown -R www-data:www-data /var/www/html 2>/dev/null || echo "Setting permissions as root"
            chmod -R 755 /var/www/html

            # Restart Nginx
            echo "ðŸ”„ Restarting Nginx..."
            systemctl reload nginx || systemctl restart nginx

            echo "âœ… React frontend deployment complete!"

      - name: âœ… Done
        run: echo "ðŸš€ React frontend deployed successfully!"
